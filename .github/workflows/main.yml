name: Update Notion with commit links

on:
  push:
    branches:
      - "**"

jobs:
  update-notion:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Parse commits and update Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          NOTION_API_VERSION: ${{ secrets.NOTION_API_VERSION || '2022-06-28' }}
        run: |
          set -e

          # Process commits directly from GitHub context
          COMMITS_JSON='${{ toJson(github.event.commits) }}'

          # Debug
          echo "$COMMITS_JSON" | jq '.'

          # Loop over commits
          echo "$COMMITS_JSON" | jq -r '.[] | {msg: .message, url: .url} | @base64' | while read row; do
            _jq() { echo "$row" | base64 --decode | jq -r "$1"; }
            MSG=$(_jq '.msg')
            URL=$(_jq '.url')

            echo "üìù Commit: $MSG"
            echo "üîó URL: $URL"

            # Extract GW-* keys
            KEYS=$(echo "$MSG" | grep -oE 'GW-[0-9]+' | sort -u)
            if [ -z "$KEYS" ]; then
              echo "‚è≠Ô∏è No GW-* keys. Skipping."
              continue
            fi

            for KEY in $KEYS; do
              echo "üîç Processing Key: $KEY"

              # Query Notion database for this KEY
              PAGE_ID=$(curl -s -X POST "https://api.notion.com/v1/databases/$NOTION_DATABASE_ID/query" \
                -H "Authorization: Bearer $NOTION_TOKEN" \
                -H "Notion-Version: $NOTION_API_VERSION" \
                -H "Content-Type: application/json" \
                --data "{\"filter\":{\"property\":\"ID\",\"rich_text\":{\"equals\":\"$KEY\"}},\"page_size\":1}" \
                | jq -r '.results[0].id // empty')

              if [ -z "$PAGE_ID" ]; then
                echo "‚ö†Ô∏è No page found with ID $KEY. Skipping."
                continue
              fi

              echo "‚úÖ Found Page ID: $PAGE_ID"

              # Get existing content
              EXISTING=$(curl -s -X GET "https://api.notion.com/v1/pages/$PAGE_ID" \
                -H "Authorization: Bearer $NOTION_TOKEN" \
                -H "Notion-Version: $NOTION_API_VERSION" \
                | jq -c '.properties["Github Commit link"].rich_text // []')

              # Append new commit link
              NEW_LINE=$(jq -nc --arg url "$URL" --arg msg "$MSG" '{type:"text", text:{content:$msg, link:{url:$url}}}')
              UPDATED=$(echo "$EXISTING" | jq --argjson new "$NEW_LINE" '. + [$new]')

              # Update Notion page
              curl -s -X PATCH "https://api.notion.com/v1/pages/$PAGE_ID" \
                -H "Authorization: Bearer $NOTION_TOKEN" \
                -H "Notion-Version: $NOTION_API_VERSION" \
                -H "Content-Type: application/json" \
                --data "$(jq -n --argjson rt "$UPDATED" '{properties: {"Github Commit link": {rich_text: $rt}}}')"

              echo "‚úÖ Updated Notion page for $KEY"
            done
          done
