name: Update Notion with commit links

on:
  push:
    branches:
      - "**"

jobs:
  update-notion:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Parse commits and update Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          NOTION_API_VERSION: ${{ secrets.NOTION_API_VERSION || '2022-06-28' }}
        run: |
          set -e

          echo "=========================================="
          echo "ðŸ”„ PROCESSING COMMITS"
          echo "=========================================="

          # Process commits directly without assigning multi-line JSON to a variable
          echo '${{ toJson(github.event.commits) }}' \
            | jq -r '.[] | {msg: .message, url: .url} | @base64' \
            | while read row; do
                _jq() { echo "$row" | base64 --decode | jq -r "$1"; }
                MSG=$(_jq '.msg')
                URL=$(_jq '.url')

                echo ""
                echo "ðŸ“ Commit: $MSG"
                echo "ðŸ”— URL: $URL"

                # Extract GW-* keys
                KEYS=$(echo "$MSG" | grep -oE 'GW-[0-9]+' | sort -u)
                if [ -z "$KEYS" ]; then
                  echo "â­ï¸ No GW-* keys. Skipping commit."
                  continue
                fi

                for KEY in $KEYS; do
                  echo "ðŸ” Processing Key: $KEY"

                  # Query first 100 rows of database
                  QUERY_RESPONSE=$(curl -s -X POST "https://api.notion.com/v1/databases/$NOTION_DATABASE_ID/query" \
                    -H "Authorization: Bearer $NOTION_TOKEN" \
                    -H "Notion-Version: $NOTION_API_VERSION" \
                    -H "Content-Type: application/json" \
                    --data '{"page_size":100}')

                  PAGE_ID=""
                  RESULTS=$(echo "$QUERY_RESPONSE" | jq -c '.results[]')

                  # Autodetect ID property type: rich_text, number, formula
                  for PAGE in $RESULTS; do
                    ID_PROP=$(echo "$PAGE" | jq -c '.properties["ID"]')
                    ID_VALUE=$(echo "$ID_PROP" | jq -r '.rich_text[0].plain_text? // empty')
                    if [ -z "$ID_VALUE" ]; then
                      ID_VALUE=$(echo "$ID_PROP" | jq -r '.number? // empty')
                    fi
                    if [ -z "$ID_VALUE" ]; then
                      ID_VALUE=$(echo "$ID_PROP" | jq -r '.formula.string? // empty')
                    fi

                    if [ "$ID_VALUE" = "$KEY" ]; then
                      PAGE_ID=$(echo "$PAGE" | jq -r '.id')
                      break
                    fi
                  done

                  if [ -z "$PAGE_ID" ]; then
                    echo "âš ï¸ No page found with ID $KEY. Skipping."
                    continue
                  fi

                  echo "âœ… Found Page ID: $PAGE_ID"

                  # Get existing Github Commit link content
                  EXISTING=$(curl -s -X GET "https://api.notion.com/v1/pages/$PAGE_ID" \
                    -H "Authorization: Bearer $NOTION_TOKEN" \
                    -H "Notion-Version: $NOTION_API_VERSION" \
                    | jq -c '.properties["Github Commit link"].rich_text // []')

                  # Create new entry for this commit
                  NEW_LINE=$(jq -nc --arg url "$URL" --arg msg "$MSG" '{type:"text", text:{content:$msg, link:{url:$url}}}')
                  UPDATED=$(echo "$EXISTING" | jq --argjson new "$NEW_LINE" '. + [$new]')

                  # Update the page
                  UPDATE_PAYLOAD=$(jq -n --argjson rt "$UPDATED" '{properties: {"Github Commit link": {rich_text: $rt}}}')
                  curl -s -X PATCH "https://api.notion.com/v1/pages/$PAGE_ID" \
                    -H "Authorization: Bearer $NOTION_TOKEN" \
                    -H "Notion-Version: $NOTION_API_VERSION" \
                    -H "Content-Type: application/json" \
                    --data "$UPDATE_PAYLOAD" >/dev/null

                  echo "âœ… Updated Notion page for $KEY"
                done
            done

          echo ""
          echo "ðŸŽ‰ Finished processing all commits"
