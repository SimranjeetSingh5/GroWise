name: Update Notion with commit links

on:
  push:
    branches:
      - "**"

jobs:
  update-notion:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Get commits payload
        id: commits
        run: |
          echo "COMMITS<<EOF" >> $GITHUB_OUTPUT
          echo '${{ toJson(github.event.commits) }}' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Parse commits and update Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          NOTION_API_VERSION: ${{ secrets.NOTION_API_VERSION }}
          COMMITS: ${{ steps.commits.outputs.COMMITS }}
        run: |
          set -e
          NOTION_API_VERSION=${NOTION_API_VERSION:-2022-06-28}

          echo "$COMMITS" | jq -r '.[] | {msg: .message, url: .url} | @base64' | while read row; do
            _jq() { echo "$row" | base64 --decode | jq -r "$1"; }
            MSG=$(_jq '.msg')
            URL=$(_jq '.url')

            # Find all GW-* IDs in commit message
            for KEY in $(echo "$MSG" | grep -oE 'GW-[0-9]+' | sort -u); do
              # Direct Notion API filter for exact ID match
              QUERY_PAYLOAD=$(jq -n --arg key "$KEY" '{
                filter: { property: "ID", rich_text: { equals: $key } },
                page_size: 1
              }')

              PAGE_ID=$(curl -s -X POST "https://api.notion.com/v1/databases/$NOTION_DATABASE_ID/query" \
                -H "Authorization: Bearer $NOTION_TOKEN" \
                -H "Notion-Version: $NOTION_API_VERSION" \
                -H "Content-Type: application/json" \
                --data "$QUERY_PAYLOAD" | jq -r '.results[0].id // empty')

              [ -z "$PAGE_ID" ] && continue

              CURRENT_PAGE=$(curl -s -X GET "https://api.notion.com/v1/pages/$PAGE_ID" \
                -H "Authorization: Bearer $NOTION_TOKEN" \
                -H "Notion-Version: $NOTION_API_VERSION")
              EXISTING=$(echo "$CURRENT_PAGE" | jq -c '.properties["Github Commit link"].rich_text // []')

              NEW_LINE=$(jq -nc --arg url "$URL" --arg msg "$MSG" '{
                type: "text",
                text: { content: $msg, link: { url: $url } }
              }')
              UPDATED=$(echo "$EXISTING" | jq --argjson new "$NEW_LINE" '. + [$new]')

              UPDATE_PAYLOAD=$(jq -n --argjson rt "$UPDATED" '{
                properties: { "Github Commit link": { rich_text: $rt } }
              }')

              curl -s -X PATCH "https://api.notion.com/v1/pages/$PAGE_ID" \
                -H "Authorization: Bearer $NOTION_TOKEN" \
                -H "Notion-Version: $NOTION_API_VERSION" \
                -H "Content-Type: application/json" \
                --data "$UPDATE_PAYLOAD"
            done
          done
